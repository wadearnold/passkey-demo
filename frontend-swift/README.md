# Passkey Demo - iOS App

Native iOS app demonstrating WebAuthn passkey authentication with cross-platform support.

## Configuration

### Prerequisites
- Xcode 15+ with Apple Developer account  
- iOS 16+ device (real device recommended)
- ngrok tunnel running

### Quick Setup

```bash
# 1. Start ngrok (from root directory)
../scripts/start-ngrok.sh

# 2. Configure iOS app
./setup-domain.sh
# Note your Team ID from output

# 3. Configure backend AASA
cd ../backend
./setup-aasa.sh YOUR_TEAM_ID

# 4. Build and run in Xcode
```

### Configuration Files

**`ngrok-config.json`** - Auto-generated by setup script
```json
{
  "ngrok_url": "https://abc123.ngrok-free.app"
}
```

**`PasskeyDemo.entitlements`** - Associated domains
```xml
<key>com.apple.developer.associated-domains</key>
<array>
    <string>webcredentials:abc123.ngrok-free.app</string>
</array>
```

## Running the App

### Development
1. Open `PasskeyDemo.xcodeproj` in Xcode
2. Select your development team
3. Build and run on **real device** (simulator has limitations)

### Important Notes
- **Always use ngrok for iOS testing** - localhost won't work with Associated Domains
- **Real device required** - Simulator has entitlements limitations
- **Team ID must match** - Between iOS app and backend AASA file

## Debugging

### Common Issues

**"Application not associated with domain" error**
- Run `./setup-domain.sh` to update configuration
- Verify AASA file is accessible:
  ```bash
  curl https://your-domain.ngrok.io/.well-known/apple-app-site-association
  ```
- Check Team ID matches in AASA response

**Passkey creation fails**
- Ensure biometrics are enabled in iOS Settings
- Check Xcode console for detailed error messages
- Verify backend is running with matching ngrok URL

**Domain verification issues**
- Clean build folder (Cmd+Shift+K)
- Delete app from device and reinstall
- Check entitlements with `./verify-entitlements.sh`

### Console Logging

Monitor Xcode console for detailed logs:
```
🚀 Starting registration for username: alice
📋 Registration options received
Challenge: ABC123...
RPID: your-domain.ngrok-free.app
🔐 Created platform authenticator request
✅ User completed biometric authentication
🎉 Registration successful
```

### System Logs
For domain verification issues:
```bash
# Open Console.app and filter by "swcd"
# Look for Associated Domains errors
```

## Testing Flows

### 1. Registration
- Tap "Create Account"
- Enter username and display name
- Authenticate with Face ID/Touch ID
- Passkey created and stored

### 2. Username Login
- Tap "Sign In"
- Enter username
- Select passkey and authenticate

### 3. Discoverable Login  
- Tap "Sign in with Passkey"
- Choose from all available passkeys
- Authenticate to login

### 4. Cross-Platform
- Register on iOS
- Open web app in Safari
- Same passkey works on web!

## Project Structure

```
PasskeyDemo/
├── Views/
│   ├── AuthenticationView.swift   # Login UI
│   ├── RegistrationView.swift     # Registration UI
│   └── DashboardView.swift        # Passkey management
├── Services/
│   ├── WebAuthnService.swift      # Core WebAuthn logic
│   └── APIService.swift           # Backend API client
├── Models/
│   └── WebAuthnModels.swift       # Data models
└── PasskeyDemo.entitlements       # Associated domains
```

## Troubleshooting ngrok Changes

When ngrok restarts with new domain:
```bash
# 1. Start new ngrok tunnel
../scripts/start-ngrok.sh

# 2. Reconfigure iOS app
./setup-domain.sh

# 3. Update backend AASA
cd ../backend && ./setup-aasa.sh YOUR_TEAM_ID

# 4. Clean build in Xcode (Cmd+Shift+K)
```

## Security Notes

- **Biometric required**: Face ID, Touch ID, or passcode
- **Secure Enclave**: Private keys never leave device
- **Domain verification**: Prevents credential phishing
- **iCloud Keychain**: Optional passkey sync

## Production Deployment

For production:
1. Replace ngrok with your domain
2. Update entitlements with production domain  
3. Deploy AASA file to your server
4. Ensure valid SSL certificate