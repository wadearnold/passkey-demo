# iOS Swift Frontend - WebAuthn Passkey Demo

An iOS app demonstrating WebAuthn passkey authentication with cross-platform support. Register a passkey on iOS and use it to login on the web!

## Quick Setup (3 Steps)

### 1. Start ngrok tunnel
```bash
cd ../
./scripts/start-ngrok.sh
```

### 2. Configure iOS app
```bash
./setup-domain.sh
```

### 3. Configure backend
```bash
cd ../backend
./setup-aasa.sh YOUR_TEAM_ID  # Use Team ID from step 2
```

Done! Build and run the iOS app on a device.

## Requirements

- **Xcode 15+** with Apple Developer account
- **iOS 16+ device** (real device recommended - simulator has limitations)
- **ngrok** tunnel running (from parent directory)

## Features

‚úÖ **Passkey Registration** - Create passkeys with biometric authentication  
‚úÖ **Username-based Login** - Enter username, then authenticate with passkey  
‚úÖ **Discoverable Login** - Passwordless login showing all available passkeys  
‚úÖ **Cross-Platform** - Passkeys work between iOS app and web browser  
‚úÖ **Passkey Management** - View and delete registered passkeys  
‚úÖ **Complete Demo** - Proper error handling, logging, and UX  

## Architecture

```
iOS App ‚Üí Backend API ‚Üí WebAuthn Library
   ‚Üì
Associated Domains ‚Üí AASA File ‚Üí Domain Verification
   ‚Üì
Face ID/Touch ID ‚Üí Secure Enclave ‚Üí Passkey Storage
```

### Key Components

- **WebAuthnService**: Core authentication logic
- **APIService**: Backend communication with automatic ngrok/localhost detection
- **Associated Domains**: Links app to backend domain for security
- **Biometric Authentication**: Uses iOS Secure Enclave for passkey storage

## Development Modes

### üö® Always Use ngrok for iOS Development

**Never use localhost mode for iOS testing.** iOS requires a proper domain for Associated Domains to work.

**‚úÖ Correct Setup:**
```bash
# 1. Start ngrok
./scripts/start-ngrok.sh

# 2. Configure iOS app for ngrok domain
./setup-domain.sh

# 3. Test on real device
```

**‚ùå Localhost Won't Work:**
- Associated domains require real FQDN
- iOS simulator has entitlements limitations
- Passkey authentication will fail

## Configuration Files

### `ngrok-config.json`
```json
{
  "ngrok_url": "https://abc123.ngrok-free.app"
}
```
Auto-generated by `./setup-domain.sh`

### `PasskeyDemo.entitlements`
```xml
<key>com.apple.developer.associated-domains</key>
<array>
    <string>webcredentials:abc123.ngrok-free.app</string>
    <string>webcredentials:localhost?mode=developer</string>
</array>
```
Auto-updated by `./setup-domain.sh`

## Testing Flows

### 1. Registration Flow
1. Open iOS app
2. Tap "Create Account"
3. Enter username and display name
4. Authenticate with Face ID/Touch ID
5. Passkey created and stored in iOS Keychain

### 2. Username Login
1. Tap "Sign In"
2. Enter username
3. iOS shows passkeys for that user
4. Authenticate with biometrics
5. Successfully logged in

### 3. Discoverable Login
1. Tap "Sign in with Passkey"
2. iOS shows all available passkeys
3. Select desired passkey
4. Authenticate with biometrics
5. Successfully logged in

### 4. Cross-Platform Testing
1. Register passkey on iOS app
2. Open Safari and visit your ngrok URL
3. Click "Sign in with Passkey" on web
4. Same passkey appears and works!

## Code Structure

```
PasskeyDemo/
‚îú‚îÄ‚îÄ PasskeyDemoApp.swift          # App entry point
‚îú‚îÄ‚îÄ ContentView.swift             # Main navigation
‚îú‚îÄ‚îÄ Views/
‚îÇ   ‚îú‚îÄ‚îÄ AuthenticationView.swift  # Login interface
‚îÇ   ‚îú‚îÄ‚îÄ RegistrationView.swift    # Registration interface
‚îÇ   ‚îî‚îÄ‚îÄ DashboardView.swift       # User dashboard with passkey management
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îú‚îÄ‚îÄ WebAuthnService.swift     # Core WebAuthn logic
‚îÇ   ‚îî‚îÄ‚îÄ APIService.swift          # Backend communication
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îî‚îÄ‚îÄ WebAuthnModels.swift      # Data models and API types
‚îú‚îÄ‚îÄ PasskeyDemo.entitlements      # Associated domains configuration
‚îî‚îÄ‚îÄ ngrok-config.json            # Runtime ngrok configuration
```

### WebAuthn Implementation

**Registration Process:**
```swift
// 1. Get challenge from server
let options = try await apiService.beginRegistration(username: username, displayName: displayName)

// 2. Create platform authenticator request
let platformProvider = ASAuthorizationPlatformPublicKeyCredentialProvider(relyingPartyIdentifier: options.rp.id)
let registrationRequest = platformProvider.createCredentialRegistrationRequest(challenge: challengeData, name: options.user.name, userID: userIdData)

// 3. Prompt for biometric authentication
let credential = try await performAuthorization(request: registrationRequest)

// 4. Send credential to server
let result = try await apiService.finishRegistration(credential: credential)
```

**Authentication Process:**
```swift
// 1. Get challenge from server (with or without username)
let options = try await apiService.beginAuthentication(username: username)

// 2. Create assertion request
let assertionRequest = platformProvider.createCredentialAssertionRequest(challenge: challengeData)

// 3. Set allowed credentials (if username provided)
if let allowedCredentials = options.allowCredentials {
    assertionRequest.allowedCredentials = allowedCredentials.map { /* convert */ }
}

// 4. Authenticate and send to server
let credential = try await performAuthorization(request: assertionRequest)
let result = try await apiService.finishAuthentication(credential: credential)
```

## Security Features

- **Biometric Authentication**: Requires Face ID, Touch ID, or device passcode
- **Secure Enclave**: Private keys never leave the device
- **Domain Verification**: Associated domains prevent credential theft
- **User Verification**: Ensures user presence during authentication
- **Resident Keys**: Enables discoverable credentials for passwordless login

## Troubleshooting

### Registration/Login Fails

**Check logs in Xcode console:**
```
‚ùå Authorization failed: Application not associated with domain
```

**Solution:** Run `./setup-domain.sh` to update configuration.

### AASA File Issues

**Test AASA accessibility:**
```bash
curl https://your-ngrok-domain.ngrok-free.app/.well-known/apple-app-site-association
```

**Should return:**
```json
{
  "webcredentials": {
    "apps": ["YOUR_TEAM_ID.com.passkey.demo.ios"]
  }
}
```

### Entitlements Not Working

**Verify entitlements in built app:**
```bash
./verify-entitlements.sh
```

**Common fixes:**
- Clean build folder (Cmd+Shift+K)
- Delete app and reinstall
- Test on real device, not simulator
- Check Team ID matches in AASA file

### ngrok Domain Changes

**When ngrok restarts with new domain:**
```bash
# 1. Get new domain
./scripts/start-ngrok.sh

# 2. Reconfigure iOS app
./setup-domain.sh

# 3. Update backend AASA file
cd ../backend && ./setup-aasa.sh YOUR_TEAM_ID

# 4. Clean build iOS app
```

## Advanced Configuration

### Custom Domain (Production)

For production deployment:

1. **Replace ngrok** with your actual domain
2. **Update entitlements** with production domain
3. **Deploy AASA file** to your server
4. **Use valid SSL certificate**

### Testing on Multiple Devices

1. **Same Apple ID**: Passkeys sync via iCloud Keychain
2. **Different Apple IDs**: Each gets separate passkeys
3. **Cross-platform**: Works between iOS and web with same credentials

## Console Logging

The app includes comprehensive logging for debugging:

```swift
üöÄ Starting registration for username: alice
üìã Registration options received
Challenge: ABC123...
RPID: your-domain.ngrok-free.app
üîê Created platform authenticator request
‚úÖ User completed biometric authentication
üéâ Registration successful for user: alice
üìä Loaded 1 passkeys for user
```

Monitor Xcode console and macOS Console.app (filter: `swcd`) for system-level debugging.

## Need Help?

1. **Check setup**: Ensure `./setup-domain.sh` completed successfully
2. **Verify AASA**: Test curl command from troubleshooting section  
3. **Use real device**: Simulator has associated domain limitations
4. **Check logs**: Monitor both Xcode console and system Console.app
5. **Fresh start**: Clean build, delete app, reinstall

---

üéâ **Success looks like**: Register a passkey on iOS ‚Üí Login on web with same passkey!